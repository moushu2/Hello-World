# 数据库

CREATE TABLE `admin` (
  `username` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '账号',
  `email` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '邮箱',
  `password` varchar(100) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '密码',
  `role` tinyint(1) DEFAULT '0' COMMENT '角色',
  `createtime` datetime DEFAULT CURRENT_TIMESTAMP,
  `updatetime` datetime DEFAULT NULL,
  PRIMARY KEY (`username`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;

CREATE TABLE `user` (
  `name` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '商家名称',
  `username` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '账号',
  `password` varchar(100) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '密码',
  `phone` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '联系方式',
  `email` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '邮箱',
  `createtime` datetime DEFAULT CURRENT_TIMESTAMP,
  `updatetime` datetime DEFAULT NULL,
  `status` tinyint(1) DEFAULT '1' COMMENT '禁用状态 1不禁用',
  `role` tinyint(1) DEFAULT '1' COMMENT '角色',
  PRIMARY KEY (`username`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;

# 后端

src/main/java/com/example/springboot

- common

  - CorsConfig.java

    ```
    package com.example.springboot.common;
    
    import org.springframework.context.annotation.Bean;
    import org.springframework.context.annotation.Configuration;
    import org.springframework.web.cors.CorsConfiguration;
    import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
    import org.springframework.web.filter.CorsFilter;
    
    @Configuration
    public class CorsConfig {//允许前端从任何来源访问后端
    
        @Bean
        public CorsFilter corsFilter() {
            UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
            CorsConfiguration corsConfiguration = new CorsConfiguration();
            corsConfiguration.addAllowedOrigin("*"); // 1 设置访问源地址
            corsConfiguration.addAllowedHeader("*"); // 2 设置访问源请求头
            corsConfiguration.addAllowedMethod("*"); // 3 设置访问源请求方法
            source.registerCorsConfiguration("/**", corsConfiguration); // 4 对接口配置跨域设置
            return new CorsFilter(source);
        }
    }
    ```

  - JwtInterceptor.java

    ```
    package com.example.springboot.common;
    
    import cn.hutool.core.util.StrUtil;
    import com.auth0.jwt.JWT;
    import com.auth0.jwt.JWTVerifier;
    import com.auth0.jwt.algorithms.Algorithm;
    import com.auth0.jwt.exceptions.JWTVerificationException;
    import com.example.springboot.entity.Admin;
    import com.example.springboot.entity.User;
    import com.example.springboot.exception.ServiceException;
    import com.example.springboot.service.IAdminService;
    import com.example.springboot.service.IUserService;
    import lombok.extern.slf4j.Slf4j;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.stereotype.Component;
    import org.springframework.web.servlet.HandlerInterceptor;
    
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;
    
    @Component
    @Slf4j
    public class JwtInterceptor implements HandlerInterceptor {//拦截器（JwtInterceptor），用于验证 JWT（JSON Web Token）的有效性
    
        private static final String ERROR_CODE_401 = "401";
    
        @Autowired
        private IAdminService adminService;
        @Autowired
        private IUserService userService;
        @Override
        public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
            String token = request.getHeader("token");
            if (StrUtil.isBlank(token)) {
                token = request.getParameter("token");
            }
    
            // 执行认证
            if (StrUtil.isBlank(token)) {
                throw new ServiceException(ERROR_CODE_401, "无token，请重新登录");
            }
            // 获取 token 中的Id
            String username;
            User user;
            Admin admin;
            try {
                username = JWT.decode(token).getAudience().get(0); // 从 Audience 获取用户名
                // 根据token中的userid查询数据库
                user = userService.getById(username);
                admin = adminService.getById(username);
            } catch (Exception e) {
                String errMsg = "token验证失败，请重新登录";
                log.error(errMsg + ", token=" + token, e);
                throw new ServiceException(ERROR_CODE_401, errMsg);
            }
            if (user == null && admin == null) {
                throw new ServiceException(ERROR_CODE_401, "用户不存在，请重新登录");
            }
    
            try {
                // 用户密码加签验证 token
                String secret = user != null ? user.getPassword() : admin.getPassword();
                if (admin!=null)
                {JWTVerifier jwtVerifier = JWT.require(Algorithm.HMAC256(admin.getPassword())).build();
                    jwtVerifier.verify(token);} // 验证token
                else{
                    JWTVerifier jwtVerifier = JWT.require(Algorithm.HMAC256(user.getPassword())).build();
                    jwtVerifier.verify(token);
                }
            } catch (JWTVerificationException e) {
                throw new ServiceException(ERROR_CODE_401, "token验证失败，请重新登录");
            }
            return true;
        }
    }
    ```

  - Result.java

    ```
    package com.example.springboot.common;
    
    import lombok.Data;
    
    @Data
    public class Result {
        private static final String SUCCESS_CODE = "200";
        private static final String ERROR_CODE = "-1";
    
        private String code;
        private Object data;
        private String msg;
    
        public static Result success() {
            Result result = new Result();
            result.setCode(SUCCESS_CODE);
            return result;
        }
    
        public static Result success(Object data) {
            Result result = new Result();
            result.setCode(SUCCESS_CODE);
            result.setData(data);
            return result;
        }
    
        public static Result error(String msg) {
            Result result = new Result();
            result.setCode(ERROR_CODE);
            result.setMsg(msg);
            return result;
        }
    
        public static Result error(String code, String msg) {
            Result result = new Result();
            result.setCode(code);
            result.setMsg(msg);
            return result;
        }
    
    }
    ```

  - WebConfig.java

    ```
    package com.example.springboot.common;
    
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.context.annotation.Configuration;
    import org.springframework.web.bind.annotation.RestController;
    import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
    import org.springframework.web.servlet.config.annotation.PathMatchConfigurer;
    import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;
    
    @Configuration
    public class WebConfig implements  WebMvcConfigurer {
    
        @Autowired
        JwtInterceptor jwtInterceptor;
    
        @Override
        public void configurePathMatch(PathMatchConfigurer configurer) {
            // 指定controller统一的接口前缀
            configurer.addPathPrefix("/api", clazz -> clazz.isAnnotationPresent(RestController.class));
        }
    
        // 加自定义拦截器JwtInterceptor，设置拦截规则
        //不对登录界面进行拦截
        @Override
        public void addInterceptors(InterceptorRegistry registry) {
            registry.addInterceptor(jwtInterceptor).addPathPatterns("/api/**").excludePathPatterns("/api/admin/login", "/api/user/login");
        }
    
    
    }
    ```

- controller

  - dto

    - LoginDTO.java

  - request

    - BaseRequest

      ```
      package com.example.springboot.controller.request;
      
      import lombok.Data;
      
      @Data
      public class BaseRequest {
          private Integer pageNum = 1;
          private Integer pageSize = 10;
      }
      ```

    - UserPageRequest.java

      ```
      package com.example.springboot.controller.request;
      
      import lombok.Data;
      
      @Data
      public class UserPageRequest extends BaseRequest{
          private String username;
          private String name;
          private String phone;
          private String email;
      }
      ```

      

    - LoginRequest.java

      ```
      package com.example.springboot.controller.request;
      
      import lombok.AllArgsConstructor;
      import lombok.Data;
      import lombok.NoArgsConstructor;
      
      @Data
      public class LoginRequest {
          private String username;
          private String password;
      }
      ```

    - PasswordRequest.java

      ```
      package com.example.springboot.controller.request;
      
      import lombok.Data;
      
      @Data
      public class PasswordRequest {
          private String username;
          private String password;
          private String newPass;
      }
      ```

    - CommentPageRequest

      ```
      package com.example.springboot.controller.request;
      
      import lombok.Data;
      
      @Data
      public class CommentPageRequest extends BaseRequest {
          private String productName; // 商品名称
          private String username;    // 用户名
          private String domain;      // 商品领域
      }
      ```

      

  - UserController.java

    ```
    package com.example.springboot.controller;
    
    import com.example.springboot.common.Result;
    import com.example.springboot.controller.dto.LoginDTO;
    import com.example.springboot.controller.request.LoginRequest;
    import com.example.springboot.controller.request.PasswordRequest;
    import com.example.springboot.controller.request.UserPageRequest;
    import com.example.springboot.entity.User;
    import com.example.springboot.service.IUserService;
    import com.example.springboot.utils.TokenUtils;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.web.bind.annotation.*;
    
    import java.security.NoSuchAlgorithmException;
    import java.util.List;
    
    @CrossOrigin
    @RestController
    @RequestMapping("/user")
    public class UserController {
    
        @Autowired
        IUserService userService;
    
        @PostMapping("/login")
        public Result login(@RequestBody LoginRequest request) throws NoSuchAlgorithmException {
            LoginDTO login = userService.login(request);
    
            System.out.println("生成的token: " + login.getToken());
            return Result.success(login);
        }
    
        @PutMapping("/password")
        public Result password(@RequestBody PasswordRequest request) {
            userService.changePass(request);
            return Result.success();
        }
    
        @PostMapping("/save")
        public Result save(@RequestBody User user) {
            userService.save(user);
            return Result.success();
        }
    
    /*
        @PostMapping("/account")
        public Result account(@RequestBody User user) {
            userService.handleAccount(user);
            return Result.success();
        }
    */
    
        @PutMapping("/update")
        public Result update(@RequestBody User user) {
            userService.update(user);
            return Result.success();
        }
    
    
    
        @DeleteMapping("/delete/{username}")
        public Result delete(@PathVariable String username ) {
            userService.deleteById(username);
            return Result.success();
        }
    
        @GetMapping("/{username}")
        public Result getById(@PathVariable String username ) {
            User user = userService.getById(username);
            return Result.success(user);
        }
    
    
        @GetMapping("/list")
        public Result list() {
            List<User> users = userService.list();
            return Result.success(users);
        }
    
        @GetMapping("/page")
        public Result page(UserPageRequest userPageRequest) {
            return Result.success(userService.page(userPageRequest));
        }
    
        @GetMapping("/current")
        public Result getCurrentOne( ) {
            User currentUser = TokenUtils.getCurrentUser();
            return Result.success(currentUser);
        }
    
    
    
    }
    ```

  - AdminController.java

    ```
    
    ```

    - AdviceController

      ```
      package com.example.springboot.controller;
      
      import com.example.springboot.common.Result;
      import com.example.springboot.controller.dto.LoginDTO;
      import com.example.springboot.controller.request.AdminPageRequest;
      import com.example.springboot.controller.request.LoginRequest;
      import com.example.springboot.controller.request.PasswordRequest;
      import com.example.springboot.entity.Admin;
      import com.example.springboot.service.IAdminService;
      import org.springframework.beans.factory.annotation.Autowired;
      import org.springframework.web.bind.annotation.*;
      
      import java.security.NoSuchAlgorithmException;
      import java.util.List;
      
      @CrossOrigin
      @RestController
      @RequestMapping("/admin")
      public class AdminController {
      
          @Autowired
          IAdminService adminService;
      
          @PostMapping("/login")
          public Result login(@RequestBody LoginRequest request) throws NoSuchAlgorithmException {
              LoginDTO login = adminService.login(request);
              return Result.success(login);
          }
      
          @PutMapping("/password")
          public Result password(@RequestBody PasswordRequest request) {
              adminService.changePass(request);
              return Result.success();
          }
      
          @PostMapping("/save")
          public Result save(@RequestBody Admin obj) {
              adminService.save(obj);
              return Result.success();
          }
      
          @PutMapping("/update")
          public Result update(@RequestBody Admin obj) {
              adminService.update(obj);
              return Result.success();
          }
      
          @DeleteMapping("/delete/{username}")
          public Result delete(@PathVariable String username) {
              adminService.deleteById(username);
              return Result.success();
          }
      
          @GetMapping("/{username}")
          public Result getById(@PathVariable String username) {
              Admin obj = adminService.getById(username);
              return Result.success(obj);
          }
      
          @GetMapping("/list")
          public Result list() {
              List<Admin> list = adminService.list();
              return Result.success(list);
          }
      
          @GetMapping("/page")
          public Result page(AdminPageRequest pageRequest) {
              return Result.success(adminService.page(pageRequest));
          }
      
      
      
      
      }
      
      ```

      

      

      

      

- entity

  - User.java

    ```
    package com.example.springboot.entity;
    
    import com.fasterxml.jackson.annotation.JsonFormat;
    import lombok.Data;
    
    import java.util.Date;
    
    @Data
    public class User {
        private String name;
        private String username;
        private String password;
        private String phone;
        private String email;
        private Integer role = 1;
        @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
        private Date createtime;
        @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
        private Date updatetime;
        private Boolean status = true;
    }
    ```

  - Admin.Java

    ```
    package com.example.springboot.entity;
    
    import com.fasterxml.jackson.annotation.JsonFormat;
    import lombok.Data;
    
    import java.util.Date;
    
    @Data
    public class Admin {
        private String username;
        private String email;
        private String password;
        private Integer role = 0;
        @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
        private Date createtime;
        @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
        private Date updatetime;
    }
    ```

- exception

  - ExceptionHandle.java

  ```
  package com.example.springboot.exception;
  
  import cn.hutool.core.util.StrUtil;
  import com.example.springboot.common.Result;
  import lombok.extern.slf4j.Slf4j;
  import org.springframework.web.bind.annotation.ExceptionHandler;
  import org.springframework.web.bind.annotation.RestControllerAdvice;
  
  @Slf4j
  @RestControllerAdvice
  public class ExceptionHandle {
  
      @ExceptionHandler(value = ServiceException.class)
      public Result serviceExceptionError(ServiceException e) {
          log.error("业务异常", e);
          String code = e.getCode();
          if (StrUtil.isNotBlank(code)) {
              return Result.error(code, e.getMessage());
          }
          return Result.error(e.getMessage());
      }
  
      @ExceptionHandler(value = Exception.class)
      public Result exceptionError(Exception e) {
          log.error("系统错误", e);
          return Result.error("系统错误");
      }
  
  }
  
  ```

  

  - ServiceException.java

    ```
    package com.example.springboot.exception;
    
    public class ServiceException extends RuntimeException{//处理业务逻辑中的异常情况:数据库连接失败、数据格式错误、权限问题等
    
        private String code;
    
        public String getCode() {
            return code;
        }
    
        public ServiceException(String message, Throwable cause) {
            super(message, cause);
        }
    
        public ServiceException(String message) {
            super(message);
        }
    
        public ServiceException(String code, String message) {
            super(message);
            this.code = code;
        }
    
    }
    
    ```

- mapper

  - UserMapper.java

    ```
    package com.example.springboot.mapper;
    
    import com.example.springboot.controller.request.BaseRequest;
    import com.example.springboot.controller.request.PasswordRequest;
    import com.example.springboot.entity.User;
    import org.apache.ibatis.annotations.Mapper;
    import org.apache.ibatis.annotations.Param;
    
    import java.util.List;
    
    @Mapper
    public interface UserMapper {
    
    //    @Select("select * from user")
        List<User> list();
    
        List<User> listByCondition(BaseRequest baseRequest);
    
        void save(User user);
    
        User getById(String username);
    
        void updateById(User user);
    
        void deleteById(String username);
    
        User getByUsername(String username);
    
        int updatePassword(PasswordRequest request);
    
        User getByUsernameAndPassword(@Param("username") String username, @Param("password") String password);
    
    }
    ```

  - AdvminMapper

    ```
    package com.example.springboot.mapper;
    
    import com.example.springboot.controller.request.BaseRequest;
    import com.example.springboot.controller.request.LoginRequest;
    import com.example.springboot.controller.request.PasswordRequest;
    import com.example.springboot.entity.Admin;
    import org.apache.ibatis.annotations.Mapper;
    import org.apache.ibatis.annotations.Param;
    
    import java.util.List;
    
    @Mapper
    public interface AdminMapper {
    
        List<Admin> list();
    
        List<Admin> listByCondition(BaseRequest baseRequest);
    
        void save(Admin obj);
    
        Admin getById(String username);
    
        void updateById(Admin user);
    
        void deleteById(String username);
    
        Admin getByUsernameAndPassword(@Param("username") String username, @Param("password") String password);
    
        int updatePassword(PasswordRequest request);
    
        Admin getByUsername(String username);
    }
    
    ```

    

- service

  - impl

    - UserService.java

    ```
    package com.example.springboot.service.impl;
    
    import cn.hutool.core.date.DateUtil;
    import cn.hutool.core.util.IdUtil;
    import cn.hutool.core.util.StrUtil;
    import cn.hutool.crypto.SecureUtil;
    import com.example.springboot.controller.dto.LoginDTO;
    import com.example.springboot.controller.request.BaseRequest;
    import com.example.springboot.controller.request.LoginRequest;
    import com.example.springboot.controller.request.PasswordRequest;
    import com.example.springboot.entity.User;
    import com.example.springboot.exception.ServiceException;
    import com.example.springboot.mapper.UserMapper;
    import com.example.springboot.service.IUserService;
    import com.example.springboot.utils.TokenUtils;
    import com.github.pagehelper.PageHelper;
    import com.github.pagehelper.PageInfo;
    import lombok.extern.slf4j.Slf4j;
    import org.springframework.beans.BeanUtils;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.dao.DuplicateKeyException;
    import org.springframework.stereotype.Service;
    
    import java.security.NoSuchAlgorithmException;
    import java.util.Date;
    import java.util.List;
    import java.util.UUID;
    
    @Slf4j
    @Service
    public class UserService implements IUserService {
        private static final String DEFAULT_PASS = "123";
        private static final String PASS_SALT = "moushu";
        @Autowired
        UserMapper userMapper;
    
        @Override
        public List<User> list() {
            return userMapper.list();
        }
    
        @Override
        public PageInfo<User> page(BaseRequest baseRequest) {
            PageHelper.startPage(baseRequest.getPageNum(), baseRequest.getPageSize());
            List<User> users = userMapper.listByCondition(baseRequest);
            return new PageInfo<>(users);
        }
        public void save(User obj) {
            if (StrUtil.isBlank(obj.getPassword())) {
                obj.setPassword(DEFAULT_PASS);
            }
            obj.setPassword(securePass(obj.getPassword()));
    
            // 检查用户名是否为空，如果为空则自动生成
            if (StrUtil.isBlank(obj.getUsername())) {
                obj.setUsername(generateUniqueUsername(obj.getName()));
            } else {
                validateUsername(obj.getUsername());
            }
    
            try {
                userMapper.save(obj);
            } catch (DuplicateKeyException e) {
                throw new ServiceException("用户名已存在");
            }
        }
    
        private String generateUniqueUsername(String name) {
            String uuid = UUID.randomUUID().toString().replace("-", "").substring(0, 8);
            return name + "_" + uuid;
        }
    
        private void validateUsername(String username) {
            if (username.length() < 5 || username.length() > 20) {
                throw new ServiceException("用户名长度必须在5到20个字符之间");
            }
            if (!username.matches("^[a-zA-Z0-9_]+$")) {
                throw new ServiceException("用户名只能包含字母、数字和下划线");
            }
            if (username.matches("^[0-9]+$")) {
                throw new ServiceException("用户名不能全为数字");
            }
            if (username.startsWith("_") || username.endsWith("_")) {
                throw new ServiceException("用户名不能以下划线开头或结尾");
            }
            // 添加敏感词过滤逻辑
            if (containsSensitiveWords(username)) {
                throw new ServiceException("用户名包含不适当内容");
            }
        }
    
        private boolean containsSensitiveWords(String username) {
            // 实现敏感词过滤逻辑
            // 例如，可以从数据库或配置文件中加载敏感词列表进行检查
            return false;
        }
    
    
        @Override
        public User getById(String username) {
            return userMapper.getById(username);
        }
    
        @Override
        public void update(User user) {
            user.setUpdatetime(new Date());
            userMapper.updateById(user);
        }
        @Override
        public void deleteById(String username) {
            userMapper.deleteById(username);
        }
    
        @Override
        public LoginDTO login(LoginRequest request) throws NoSuchAlgorithmException {
            User user = null;
            try {
                user = userMapper.getByUsername(request.getUsername());
            } catch (Exception e) {
                log.error("根据用户名{} 查询出错", request.getUsername());
                throw new ServiceException("用户名错误");
            }
            if (user == null) {
                throw new ServiceException("用户名不存在");
            }
            // 判断密码是否合
            String securePass = securePass(request.getPassword());
    
            if (!securePass.equals(user.getPassword())) {//数据库查询结果与加盐的输入密码对比
                log.info("输入密码加密后: {}", securePass);
                log.info("数据库存储密码: {}", user.getPassword());
                throw new ServiceException("密码错误");
            }
            if (!user.getStatus()) {
                throw new ServiceException("当前用户处于禁用状态，请联系管理员：admin1@qq.com");
            }
            LoginDTO loginDTO = new LoginDTO();
            BeanUtils.copyProperties(user, loginDTO);
    
            // 生成token
            String token = TokenUtils.genToken(user.getUsername(), user.getPassword());
            loginDTO.setToken(token);
            return loginDTO;
        }
        @Override
        public void changePass(PasswordRequest request) {
            // 注意 你要对新的密码进行加密
            request.setNewPass(securePass(request.getNewPass()));
            int count = userMapper.updatePassword(request);
            if (count <= 0) {
                throw new ServiceException("修改密码失败");
            }
        }
        private String securePass(String password) {
            return SecureUtil.md5(password + PASS_SALT);
        }
    }
    ```

    - AdminService.java

    ```
    package com.example.springboot.service.impl;
    
    import cn.hutool.core.util.StrUtil;
    import cn.hutool.crypto.SecureUtil;
    import com.example.springboot.controller.dto.LoginDTO;
    import com.example.springboot.controller.request.BaseRequest;
    import com.example.springboot.controller.request.LoginRequest;
    import com.example.springboot.controller.request.PasswordRequest;
    import com.example.springboot.entity.Admin;
    import com.example.springboot.exception.ServiceException;
    import com.example.springboot.mapper.AdminMapper;
    import com.example.springboot.service.IAdminService;
    import com.example.springboot.utils.TokenUtils;
    import com.github.pagehelper.PageHelper;
    import com.github.pagehelper.PageInfo;
    import lombok.extern.slf4j.Slf4j;
    import org.springframework.beans.BeanUtils;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.dao.DuplicateKeyException;
    import org.springframework.stereotype.Service;
    import java.security.NoSuchAlgorithmException;
    import java.util.Date;
    import java.util.List;
    
    @Slf4j
    @Service
    public class AdminService implements IAdminService {
    
        @Autowired
        AdminMapper adminMapper;
    
        private static final String DEFAULT_PASS = "123";
        private static final String PASS_SALT = "moushu";
    
        @Override
        public List<Admin> list() {
            return adminMapper.list();
        }
    
        @Override
        public PageInfo<Admin> page(BaseRequest baseRequest) {
            PageHelper.startPage(baseRequest.getPageNum(), baseRequest.getPageSize());
            List<Admin> users = adminMapper.listByCondition(baseRequest);
            return new PageInfo<>(users);
        }
        @Override
        public void save(Admin obj) {
            // 默认密码 123
            if (StrUtil.isBlank(obj.getPassword())) {
                obj.setPassword(DEFAULT_PASS);
            }
            obj.setPassword(securePass(obj.getPassword()));  // 设置md5加密，加盐
            try {
                adminMapper.save(obj);
            } catch (DuplicateKeyException e) {
                log.error("数据插入失败， username:{}", obj.getUsername(), e);
                throw new ServiceException("用户名重复");
            }
        }
        @Override
        public Admin getById(String username) {
            return adminMapper.getById(username);
        }
    
        @Override
        public void update(Admin user) {
            user.setUpdatetime(new Date());
            adminMapper.updateById(user);
        }
    
        @Override
        public void deleteById(String username) {
            adminMapper.deleteById(username);
        }
        @Override
        public LoginDTO login(LoginRequest request) throws NoSuchAlgorithmException {
            Admin admin = null;
            try {
                admin = adminMapper.getByUsername(request.getUsername());
            } catch (Exception e) {
                log.error("根据用户名{} 查询出错", request.getUsername());
                throw new ServiceException("用户名错误");
            }
            if (admin == null) {
                throw new ServiceException("用户名或密码错误");
            }
            // 判断密码
            String securePass = securePass(request.getPassword());//将用户输入的密码与盐拼接在一起。
            if (!securePass.equals(admin.getPassword())) {//数据库查询结果与加盐的输入密码对比
                throw new ServiceException("用户名或密码错误");
            }
    /*        if (!admin.isStatus()) {
                throw new ServiceException("当前用户处于禁用状态，请联系管理员：admin1@qq.com");
            }*/
            LoginDTO loginDTO = new LoginDTO();
            BeanUtils.copyProperties(admin, loginDTO);
            // 生成token
            String token = TokenUtils.genToken(admin.getUsername(), admin.getPassword());
            loginDTO.setToken(token);
            return loginDTO;
        }
        @Override
        public void changePass(PasswordRequest request) {
            // 注意 你要对新的密码进行加密
            request.setNewPass(securePass(request.getNewPass()));
            int count = adminMapper.updatePassword(request);
            if (count <= 0) {
                throw new ServiceException("修改密码失败");
            }
        }
    
        private String securePass(String password) {
            return
                    SecureUtil.md5(password + PASS_SALT);//将用户输入的密码与盐拼接在一起。对拼接后的字符串进行MD5加密。
        }
    
    }
    
    ```

  - IUserService.java

  - IdminService.java

- utils

  - TokenUtils.java

    ```
    package com.example.springboot.utils;
    
    import cn.hutool.core.date.DateUtil;
    import cn.hutool.core.util.StrUtil;
    import com.auth0.jwt.JWT;
    import com.auth0.jwt.algorithms.Algorithm;
    import com.example.springboot.entity.Admin;
    import com.example.springboot.entity.User;
    import com.example.springboot.service.IAdminService;
    import com.example.springboot.service.IUserService;
    import lombok.extern.slf4j.Slf4j;
    import org.springframework.stereotype.Component;
    import org.springframework.web.context.request.RequestContextHolder;
    import org.springframework.web.context.request.ServletRequestAttributes;
    
    import javax.annotation.PostConstruct;
    import javax.annotation.Resource;
    import javax.servlet.http.HttpServletRequest;
    import java.util.Date;
    
    @Component
    @Slf4j
    public class TokenUtils {
    
        private static IAdminService staticAdminService;
        private static IUserService staticUserService;
    
        @Resource
        private IAdminService adminService;
    
        @Resource
        private IUserService userService;
    
        @PostConstruct
        public void setUserService() {
            staticAdminService = adminService;
            staticUserService = userService;
        }
    
        /**
         * 生成token
         *
         * @return
         */
        public static String genToken(String username, String sign) {
            return JWT.create().withAudience(username) // 将 username保存到 token 里面,作为载荷
                    .withExpiresAt(DateUtil.offsetHour(new Date(), 2)) // 2小时后token过期
                    .sign(Algorithm.HMAC256(sign)); // 以 password 作为 token 的密钥
        }
    
        public static String genToken(String username, String sign, int days) {
            return JWT.create().withAudience(username) // 将 username保存到 token 里面,作为载荷
                    .withExpiresAt(DateUtil.offsetDay(new Date(), days)) // x天后token过期
                    .sign(Algorithm.HMAC256(sign)); // 以 password 作为 token 的密钥
        }
    
        /**
         * 获取当前登录的用户信息
         *
         * @return user对象
         *  /admin?token=xxxx
         */
        public static Admin getCurrentAdmin() {
            String token = null;
            try {
                HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
                token = request.getHeader("token");
                if (StrUtil.isBlank(token)) {  // header没有  那就从参数获取
                    token = request.getParameter("token");
                }
                if (StrUtil.isBlank(token)) {
                    log.error("获取当前登录的token失败， token: {}", token);
                    return null;
                }
                String username  = JWT.decode(token).getAudience().get(0);
                return staticAdminService.getById(username);
            } catch (Exception e) {
                log.error("获取当前登录的管理员信息失败, token={}", token,  e);
                return null;
            }
        }
        public static User getCurrentUser() {
            String token = null;
            try {
                HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
                token = request.getHeader("token");
                if (StrUtil.isBlank(token)) {  // header没有  那就从参数获取
                    token = request.getParameter("token");
                }
                if (StrUtil.isBlank(token)) {
                    log.error("获取当前登录的token失败， token: {}", token);
                    return null;
                }
                String username = JWT.decode(token).getAudience().get(0);
                return staticUserService.getById(username);
            } catch (Exception e) {
                log.error("获取当前登录的管理员信息失败, token={}", token,  e);
                return null;
            }
        }
    }
    ```

  - PythonExecutor

    ```
    package com.example.springboot.utils;
    
    import com.example.springboot.mapper.AnalysisMapper;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.scheduling.annotation.Async;
    import org.springframework.stereotype.Component;
    
    import java.io.BufferedReader;
    import java.io.InputStreamReader;
    import java.nio.charset.StandardCharsets;
    
    @Async
    @Component
    public class PythonExecutor {
    
        @Autowired
        private AnalysisMapper analysisMapper;
    
    
        // 通用 Python 脚本执行方法
       public void runPythonScript(String scriptName, String username, String productName) throws Exception {
            ProcessBuilder pb = new ProcessBuilder(
                    "C:\\ProgramData\\anaconda3\\envs\\py39\\python.exe", // 指定 Python 解释器路径
                    "D:\\Code\\pythonProject\\scripts\\" + scriptName,
                    username,
                    productName
            );
    // 重定向错误流到标准输出
            pb.redirectErrorStream(true);
            Process process = pb.start();
    // 使用 UTF-8 编码读取 Python 脚本的输出
            try (BufferedReader reader = new BufferedReader(
                    new InputStreamReader(process.getInputStream(), StandardCharsets.UTF_8))) {
                String line;
                while ((line = reader.readLine()) != null) {
                    System.out.println("[PYTHON LOG] " + line);
                }
            }
    
            int exitCode = process.waitFor();
            System.out.println("Python 脚本执行完成，退出码: " + exitCode);
    
            if (exitCode != 0) {
                throw new RuntimeException(scriptName + " 执行失败，退出码: " + exitCode);
            }
        }
    
        // 检查 processed_comment 是否有数据
        public boolean isProcessedCommentsExist(String username, String productName) {
            Integer count = analysisMapper.countProcessedComments(username, productName);
            return count != null && count > 0;
        }
    
        // 检查 high_frequency_words 是否有数据
        public boolean isHighFrequencyWordsExist(String username, String productName) {
            Integer count = analysisMapper.countHighFrequencyWords(username, productName);
            return count != null && count > 0;
        }
    
        public void CheckData(String username, String productName) throws Exception {
            // 1. 检查 processed_comment 是否存在数据
            if (!isProcessedCommentsExist(username, productName)) {
                System.out.println("processed_comment 数据缺失，开始调用 sentiment_predict.py");
                runPythonScript("sentiment_predict.py", username, productName);
                System.out.println("sentiment_predict.py 执行完成");
            } else {
                System.out.println("processed_comment 数据已存在，跳过情感预测");
            }
    
            // 2. 检查 high_frequency_words 是否存在数据
            if (!isHighFrequencyWordsExist(username, productName)) {
                System.out.println("high_frequency_words 数据缺失，开始调用 generate_keywords.py");
                runPythonScript("generate_keywords.py", username, productName);
                System.out.println("generate_keywords.py 执行完成");
            } else {
                System.out.println("high_frequency_words 数据已存在，跳过高频词生成");
            }
        }
    
    }
    ```

src/main/resources

- mapper

  - User.xml

    ```
    <?xml version="1.0" encoding="UTF-8" ?>
    <!DOCTYPE mapper
            PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
            "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="com.example.springboot.mapper.UserMapper">
    
        <insert id="save">
            insert into user(name, password, username, phone,email)
            values(#{name},#{password},#{username}, #{phone},#{email})
        </insert>
    
        <update id="updateById">
            update user set name = #{name},email=#{email},  phone = #{phone}, status = #{status},
            updatetime = #{updatetime} where username = #{username}
        </update>
        <update id="updatePassword">
            update user set password = #{newPass} where username = #{username} and password = #{password}
        </update>
    
        <delete id="deleteById">
            delete from user where username = #{username}
        </delete>
    
        <select id="list" resultType="com.example.springboot.entity.User">
            select * from user
        </select>
    
        <select id="listByCondition" resultType="com.example.springboot.entity.User">
            select * from user
                <where>
                    <if test="name != null and name != ''">
                        name like concat('%', #{ name }, '%')
                    </if>
                    <if test="username != null and username != ''">
                        and username  like concat('%', #{username }, '%')
                    </if>
                </where>
            order by username desc
        </select>
    
        <select id="getById" resultType="com.example.springboot.entity.User">
            select * from user where username = #{username}
        </select>
    
        <select id="getByUsername" resultType="com.example.springboot.entity.User">
            select * from user where username = #{username}
        </select>
        <select id="getByUsernameAndPassword" resultType="com.example.springboot.entity.User">
            select * from  user where username = #{username} and password = #{password}
        </select>
    
    </mapper>
    ```

  - Admin.xml

    ```
    <?xml version="1.0" encoding="UTF-8" ?>
    <!DOCTYPE mapper
            PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
            "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="com.example.springboot.mapper.AdminMapper">
    
        <insert id="save">
            insert into admin(username, password,  email)
            values(#{username}, #{password},  #{email})
        </insert>
    
        <update id="updateById">
            update admin set username = #{username}, email = #{email}, updatetime = #{updatetime}, status = #{status} where username = #{username}
        </update>
    
        <update id="updatePassword">
            update admin set password = #{newPass} where username = #{username} and password = #{password}
        </update>
    
        <delete id="deleteById">
            delete from admin where username= #{username}
        </delete>
    
        <select id="list" resultType="com.example.springboot.entity.Admin">
            select * from admin order by username desc
        </select>
    
        <select id="listByCondition" resultType="com.example.springboot.entity.Admin">
            select * from admin
            <where>
                <if test="username != null and username != ''">
                    username like concat('%', #{username}, '%')
                </if>
    
                <if test="email != null and email != ''">
                    and email  like concat('%', #{email}, '%')
                </if>
            </where>
            order by username desc
        </select>
    
        <select id="getById" resultType="com.example.springboot.entity.Admin">
            select * from admin where username = #{username}
        </select>
    
        <select id="getByUsernameAndPassword" resultType="com.example.springboot.entity.Admin">
            select * from admin where username = #{username} and password = #{password}
        </select>
    
        <select id="getByUsername" resultType="com.example.springboot.entity.Admin">
            select * from admin where username = #{username}
        </select>
    
    </mapper>
    ```


# 前端

- vue/src/utils/request.js

  ```
  import axios from 'axios'  //用于发送HTTP请求的库
  import router from "@/router";
  import Cookies from 'js-cookie'
  
  const request = axios.create({
      baseURL: 'http://localhost:9197/api',
      timeout: 100000
  })
  
  // request 拦截器
  // 可以自请求发送前对请求做一些处理
  // 比如统一加token，对请求参数统一加密
  /*request.interceptors.request.use(config => {
      config.headers['Content-Type'] = 'application/json;charset=utf-8';
  
      const adminJson = Cookies.get('admin')
      const userJson = Cookies.get('user')
      if (adminJson) {
          // 设置请求头
          config.headers['token'] = JSON.parse(adminJson).token
      }
      if (userJson) {
          // 设置请求头
          config.headers['token'] = JSON.parse(userJson).token
      }
      return config
  }, error => {
      return Promise.reject(error)
  });*/
  
  // 新增请求拦截器：自动添加 Token 到 Header
  request.interceptors.request.use(config => {
      const token = localStorage.getItem('token') // 从 localStorage 获取 token
      if (token) {
          config.headers.token = token // 关键：设置请求头字段为 token
      }
      return config
  })
  
  // response 拦截器
  // 可以在接口响应后统一处理结果
  request.interceptors.response.use(
      response => {
          let res = response.data;
          // 兼容服务端返回的字符串数据
          if (typeof res === 'string') {
              res = res ? JSON.parse(res) : res
          }
          if (res.code === '401') {
              router.push('/login')
          }
          return res;
      },
      error => {
          console.log('err' + error) // for debug
          return Promise.reject(error)
      }
  )
  
  
  export default request
  
  ```

- vue/src/router

  ```
  import Vue from 'vue'
  import VueRouter from 'vue-router'
  import Layout from '../views/Layout.vue'
  import Cookies from "js-cookie";
  
  Vue.use(VueRouter)
  
  const routes = [
    //  ====== 登录  =====
    {
      path: '/login',
      name: 'Login',
      component: () => import('@/views/Login'),
    },
      //  ====== 主页  =====
    {
      path: '/',
      name: 'Layout',
      component: Layout,
      redirect: to => {
        const role = localStorage.getItem('role')
        if (role === '0') {
          return '/AdminHome'
        } else if (role === '1') {
          return '/UserHome'
        } else {
          return '/login'
        }
      },
  
      children: [  // 子路由
          /*=============面向用户的路由============*/
        {
          path: 'UserHome',
          name: 'UserHome',
          component: () => import('@/views/UserPage/home/UserHome.vue'),
          meta: { role: '1' }
        },
          //==========个人信息==========
        {
          path: 'UserInfo',
          name: 'UserInfo',
          component: () => import('@/views/UserPage/user/UserInfo.vue'),
        },
        {
          path: 'EditInfo',
          name: 'EditInfo',
          component: () => import('@/views/UserPage/user/EditInfo.vue'),
        },
        { path: 'upload', component: () => import('@/views/UserPage/analysis/DataUpload.vue') },
        {
          path: '/raw-data',
          component: () => import('@/views/UserPage/data/RawData.vue'),
          meta: { title: '原始数据看板' }
        },
  
        // 情感分析
  
        {
          path: 'sentiment-polarity',
          component: () => import('@/views/UserPage/analysis/SentimentPolarity.vue'),
          meta: { title: '情感极性分布' }
        },
        {
          path: 'frequency-spectrum',
          component: () => import('@/views/UserPage/analysis/FrequencySpectrum.vue'),
          meta: { title: '高频词谱分析' }
        },
        { path: 'semantic-cloud', component: () => import('@/views/UserPage/analysis/SemanticCloud.vue') },
  
        // 策略生成
        { path: 'advice', component: () => import('@/views/UserPage/analysis/AdviceGeneration.vue') },
        { path: 'advice-library', component: () => import('@/views/UserPage/analysis/AdviceLibrary.vue') },
  
  
  
         /*=============面向管理员的路由==============*/
  
        {
          path: 'AdminHome',
          name: 'AdminHome',
          component: () => import('@/views/AdminPage/home/AdminHome.vue'),
          meta: { role: '0' }
        },
        {path: 'lineChart', name: 'LineChart', component: () => import('@/views/AdminPage/lineChart/LineChart.vue'),},
  
        /*=============面向管理员的路由==============*/
        //  ====  User  ====
  
        {path: 'userList', name: 'UserList', component: () => import('@/views/AdminPage/user/List.vue'),},
        {path: 'add', name: 'Add', component: () => import('@/views/AdminPage/user/Add.vue'),},
        {path: 'editUser', name: 'Edit', component: () => import('@/views/AdminPage/user/Edit.vue'),},
  
  
        //  ====  Admin  ====
        {path: 'adminList', name: 'AdminList', component: () => import('@/views/AdminPage/admin/List.vue'),},
        {path: 'addAdmin', name: 'AddAdmin', component: () => import('@/views/AdminPage/admin/Add.vue'),},
        {path: 'editAdmin', name: 'EditAdmin', component: () => import('@/views/AdminPage/admin/Edit.vue'),},
  
  
  
      ]
    },
    {
      //==========权限=========
      path:'/403',name:'Auth',component:()=>import('@/views/403.vue')
  
    },
  
    {
      path: "*",
      component:() => import('@/views/404')
    }
  ]
  
  const router = new VueRouter({
    mode: 'history',
    base: process.env.BASE_URL,
    routes
  })
  
  //路由守卫
  router.beforeEach((to, from, next) => {
    if (to.path === '/login') {
      next();
    } else {
      const userCookie = Cookies.get('admin') || Cookies.get('user');
      if (!userCookie) {
        console.log("----用户未登录重新跳转login页面----");
        next("/login");
      } else {
        let adminPaths =['/userList', '/add', '/editUser', '/adminList', '/addAdmin', '/editAdmin',
          '/categoryList', '/addCategory', '/editCategory',  '/addBook', '/editBook',
          '/borrowList', '/addBorrow', '/editBorrow', '/returList'];
        let userPaths = ['/UserInfo', '/borrow', '/borrowHistory', '/returHistory','/search'];
        let role = JSON.parse(localStorage.getItem('role') || '{}');
        console.log("======路由守卫 role=")
        console.log(role)
        if (role =='1' &&  adminPaths.includes(to.path)) {
          next('/403');
        } else if (role == '0' && userPaths.includes(to.path)) {
          next('/403');
        } else {
          console.log("-------路由守卫-------");
          console.log(to.path);
          console.log("-------路由守卫-------");
          next();
        }
      }
    }
  });
  
  
  
  export default router
  ```

- login

```
<template>
  <div style="display: flex; align-items: center; justify-content: center; background-color: #f5f5f5; height: 100vh;">
    <div style="width: 1200px; background: white; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); overflow: hidden;">
      <div style="display: flex; height: 600px;">
        <!-- 左侧图片区域 -->
        <div style="flex: 1; position: relative;">
          <img src="@/assets/系统logo.png" alt="" style="width: 100%; height: 100%; object-fit: cover;">
          <!-- 图片遮罩 -->
          <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(228, 57, 60, 0.6);"></div>
          <!-- 图片上的文字 -->
          <div style="position: absolute; top: 40px; left: 40px; color: white; text-align: left;">
            <div style="font-size: 28px; font-weight: 600; font-family: 'PingFang SC', sans-serif;">
              电商情感分析系统
            </div>
            <div style="font-size: 18px; font-family: 'Arial', sans-serif; margin-top: 10px;">
              EcomSentiment
            </div>
          </div>
        </div>

        <!-- 右侧表单区域 -->
        <div style="flex: 1; padding: 80px 60px; display: flex; align-items: center; justify-content: center;">
          <el-form :model="user" :rules="rules" ref="loginForm" style="width: 100%;">
            <div style="color: #333; font-size: 24px; margin-bottom: 40px; font-weight: 600; font-family: 'PingFang SC', sans-serif;">
              欢迎登录
            </div>

            <!-- 用户名输入框 -->
            <el-form-item prop="username">
              <el-input
                  placeholder="请输入账号"
                  v-model="user.username"
                  style="border-radius: 4px;"
                  class="jd-input"
              >
                <template #prefix>
                  <i class="el-icon-user" style="color: #999;"></i>
                </template>
              </el-input>
            </el-form-item>

            <!-- 密码输入框 -->
            <el-form-item prop="password">
              <el-input
                  placeholder="请输入密码"
                  show-password
                  v-model="user.password"
                  class="jd-input"
              >
                <template #prefix>
                  <i class="el-icon-lock" style="color: #999;"></i>
                </template>
              </el-input>
            </el-form-item>

            <!-- 角色选择 -->
            <el-form-item prop="role">
              <el-radio-group v-model="user.role">
                <el-radio label="0" class="jd-radio">管理员</el-radio>
                <el-radio label="1" class="jd-radio">普通商家</el-radio>
              </el-radio-group>
            </el-form-item>

            <!-- 登录按钮 -->
            <el-form-item>
              <el-button
                  style="width: 100%; height: 44px; font-size: 16px;"
                  class="jd-btn"
                  @click="login"
              >
                登录
              </el-button>
            </el-form-item>
          </el-form>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import request from "@/utils/request";
import Cookies from 'js-cookie'

export default {
  name: 'LOGIN',
  data() {
    return {
      user: {
        username: "",
        password: "",
        role: '0', // 默认角色为管理员
      },
      rules: {
        username: [
          { required: true, message: '请输入用户名', trigger: 'blur' },
          { min: 2, max: 20, message: '长度在2-20个字符', trigger: 'blur' }
        ],
        password: [
          { required: true, message: '请输入密码', trigger: 'blur' },
          { min: 2, max: 10, message: '长度在2-10个字符', trigger: 'blur' }
        ],
        role: [
          { required: true, message: '请选择角色', trigger: 'blur' },
        ],
      }
    }
  },
  methods: {
    login() {
      this.$refs['loginForm'].validate((valid) => {
        if (valid) {
          if (this.user.role === '0') {
            request.post('/admin/login', this.user).then(res => {
              if (res.code === '200') {
                this.$notify.success("登录成功");
                if (res.data !== null) {
                  Cookies.set('admin', JSON.stringify(res.data));
                  localStorage.setItem('role', '0');
                  localStorage.setItem('token', res.data.token);
                  console.log("Token 已存入 localStorage:", localStorage.getItem("token"));
                }
                this.$router.push('/');
              } else {
                this.$notify.error(res.msg);
              }
            });
          } else if (this.user.role === '1') {
            request.post('/user/login', this.user).then(res => {
              if (res.code === '200') {
                localStorage.setItem('username', res.data.username); // 存储用户名
                this.$notify.success("登录成功");
                if (res.data !== null) {
                  Cookies.set('user', JSON.stringify(res.data));
                  localStorage.setItem('role', '1');
                  localStorage.setItem('token', res.data.token);
                  console.log("Token 已存入 localStorage:", localStorage.getItem("token"));
                  console.log("登录返回的数据:", res.data);

                }
                this.$router.push('/');
              } else {
                this.$notify.error(res.msg);
              }
            });
          }
        }
      });
    },
  }
}
</script>

<style scoped>
/* 京东红主色 */
:deep(.jd-btn) {
  background: #e4393c !important;
  border-color: #e4393c !important;
  border-radius: 4px !important;
  transition: opacity 0.3s;
  color: white;
}
:deep(.jd-btn:hover) {
  opacity: 0.9;
}

/* 输入框样式 */
:deep(.jd-input .el-input__inner) {
  height: 44px !important;
  border-radius: 4px !important;
  border: 1px solid #ddd !important;
  transition: border-color 0.3s;
}
:deep(.jd-input .el-input__inner:focus) {
  border-color: #e4393c !important;
  box-shadow: 0 0 4px rgba(228, 57, 60, 0.2) !important;
}

/* 单选框样式 */
:deep(.jd-radio .el-radio__label) {
  color: #666 !important;
  font-family: 'PingFang SC', sans-serif;
}
:deep(.jd-radio .el-radio__input.is-checked .el-radio__inner) {
  background: #e4393c !important;
  border-color: #e4393c !important;
}
</style>
```

Layout

```
<template>
  <div>
    <!-- 头部区域 -->
    <div style="height: 60px; line-height: 60px; background-color: #ffffff; margin-bottom: 2px; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
      <div style="display: flex; align-items: center;">
        <img src="@/assets/系统logo.png" alt="" style="width: 60px; height: 60px; margin-left: 20px;">
        <span style="margin-left: 20px; font-size: 24px; font-family: 'PingFang SC', sans-serif; color: #e1251b; font-weight: bold;">电商情感分析系统</span>
        <span style="font-size: 20px; font-family: Arial, sans-serif; color: #666; margin-left: 20px;font-weight: bold;">EcomSentiment</span>
      </div>
      <div style="flex: 1; text-align: right; padding-right: 20px;">
        <el-dropdown size="medium">
          <div style="display: flex; align-items: center;">
            <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; margin-right: 10px;">
              <img src="@/assets/管理员头像.png" alt="用户头像" style="width: 100%; height: 100%;">
            </div>
            <span style="color: #333;font-weight: bold;" v-if="role==='0'">你好，管理员 {{ admin.username}}</span>
            <span style="color: #333;font-weight: bold;" v-if="role==='1'">你好，用户 {{ name }}</span>
            <i class="el-icon-arrow-down el-icon--right" style="color: #666;"></i>
          </div>
          <el-dropdown-menu slot="dropdown" style="margin-top: -5px;">
            <el-dropdown-item><div style="width: 100px; text-align: center;" @click="logout">退出登录</div></el-dropdown-item>
            <el-dropdown-item><div style="width: 100px; text-align: center;" @click="showPasswordDialog">修改密码</div></el-dropdown-item>
          </el-dropdown-menu>
        </el-dropdown>

        <!-- 修改密码对话框 -->
        <el-dialog title="修改密码" :visible.sync="dialogFormVisible" width="30%">
          <el-form :model="form" label-width="100px" ref="formRef" :rules="rules">
            <el-form-item label="新密码" prop="newPass">
              <el-input v-model="form.newPass" autocomplete="off" show-password></el-input>
            </el-form-item>
          </el-form>
          <div slot="footer" class="dialog-footer">
            <el-button @click="dialogFormVisible = false">取 消</el-button>
            <el-button type="primary" @click="savePass">确 定</el-button>
          </div>
        </el-dialog>
      </div>
    </div>

    <!-- 侧边栏和主体 -->
    <div style="display: flex">
      <!-- 侧边栏导航 -->
      <div class="sidebar">
        <el-menu :default-active="$route.path" router class="el-menu-vertical-demo">

          <!-- =============== 管理员界面 ============== -->
          <template v-if="role==='0'">
            <!-- 管理员首页（原首页） -->
            <el-menu-item index="/AdminHome">
              <i class="el-icon-house"></i>
              <span>首页</span>
            </el-menu-item>


            <!-- 用户管理（原读者中心路由） -->
            <el-submenu index="user">
              <template slot="title">
                <i class="el-icon-user"></i>
                <span>用户管理</span>
              </template>
              <el-menu-item index="/add">注册新用户</el-menu-item>
              <el-menu-item index="/userList">用户列表</el-menu-item>
            </el-submenu>


            <!-- AI模型运维 -->
            <el-submenu index="ai-model">
              <template slot="title">
                <i class="el-icon-cpu"></i>
                <span>AI模型运维</span>
              </template>
              <el-menu-item index="/model-version">模型版本管理</el-menu-item>
              <el-menu-item index="/model-training">模型训练监控</el-menu-item>

            </el-submenu>

            <!-- 数据资产管理 -->
            <el-submenu index="data-assets">
              <template slot="title">
                <i class="el-icon-data-analysis"></i>
                <span>数据资产管理</span>
              </template>
              <el-menu-item index="/crawler-config">爬虫配置中心</el-menu-item>
              <el-menu-item index="/data-cleaning">数据清洗规则配置</el-menu-item>

            </el-submenu>

            <!-- 系统监控台 -->
            <el-submenu index="system-monitor">
              <template slot="title">
                <i class="el-icon-monitor"></i>
                <span>系统监控台</span>
              </template>
              <el-menu-item index="/real-time-monitor">实时服务监控</el-menu-item>
              <el-menu-item index="/log-audit">日志审计</el-menu-item>
            </el-submenu>

            <!-- 消息中心 -->
            <el-submenu index="message-center">
              <template slot="title">
                <i class="el-icon-message"></i>
                <span>消息中心</span>
              </template>
              <el-menu-item index="/system-notifications">系统通知</el-menu-item>
              <el-menu-item index="/user-messages">用户消息</el-menu-item>
              <el-menu-item index="/message-management">消息管理</el-menu-item>
              <el-menu-item index="/notification-settings">通知设置</el-menu-item>
            </el-submenu>
          </template>

          <!-- =============== 商家界面 ============== -->
          <template v-if="role==='1'">
            <!-- 用户首页（原用户首页） -->
            <el-menu-item index="/UserHome">
              <i class="el-icon-house"></i>
              <span>首页</span>
            </el-menu-item>


            <el-menu :default-active="$route.path" router>
              <!-- 数据管理 -->
              <el-submenu index="data-management">
                <template slot="title">
                  <i class="el-icon-data-analysis"></i>
                  <span>数据管理</span>
                </template>
                <el-menu-item index="/upload">
                  <i class="el-icon-upload"></i>
                  <span>批量数据导入</span>
                </el-menu-item>
                <el-menu-item index="/raw-data">
                  <i class="el-icon-document"></i>
                  <span>原始数据看板</span>
                </el-menu-item>
              </el-submenu>

              <!-- 情感分析 -->
              <el-submenu index="sentiment-analysis">
                <template slot="title">
                  <i class="el-icon-s-opportunity"></i>
                  <span>情感分析</span>
                </template>
                <el-menu-item index="/sentiment-polarity">
                  <i class="el-icon-pie-chart"></i>
                  <span>情感极性分布</span>
                </el-menu-item>
                <el-menu-item index="/semantic-cloud">
                  <i class="el-icon-cloudy"></i>
                  <span>语义特征云图</span>
                </el-menu-item>
                <el-menu-item index="/frequency-spectrum">
                  <i class="el-icon-data-line"></i>
                  <span>高频词谱分析</span>
                </el-menu-item>
              </el-submenu>

              <!-- 改进建议 -->
              <el-submenu index="advice-generation">
                <template slot="title">
                  <i class="el-icon-lightning"></i>
                  <span>策略生成</span>
                </template>
                <el-menu-item index="/advice">
                  <i class="el-icon-magic-stick"></i>
                  <span>智能建议生成</span>
                </el-menu-item>
                <el-menu-item index="/advice-library">
                  <i class="el-icon-notebook-2"></i>
                  <span>策略知识库</span>
                </el-menu-item>
              </el-submenu>
            </el-menu>

            <!-- 个人工作空间 -->
            <el-submenu index="personal-workspace">
              <template slot="title">
                <i class="el-icon-s-custom"></i>
                <span>个人工作空间</span>
              </template>
<!--              <el-menu-item index="/analysis-tasks">分析任务队列</el-menu-item>-->
              <el-menu-item index="/UserInfo">个人信息中心</el-menu-item>
              <el-menu-item index="/message-center">消息中心</el-menu-item>
<!--              <el-menu-item index="/message-management">消息管理</el-menu-item>
              <el-menu-item index="/notification-settings">通知设置</el-menu-item>-->
            </el-submenu>
          </template>
        </el-menu>
      </div>

      <!-- 主体数据 -->
      <div class="main-content">
        <router-view />
      </div>
    </div>
  </div>
</template>

<script>
import Cookies from 'js-cookie'
import request from "@/utils/request";

export default {
  name: "Layout.vue",
  data() {
    return {
      form:{},// 对应PasswordRequest
      rules: {
        newPass: [
          {required: true, message: '请输入新密码', trigger: 'blur'},
          {min: 3, max: 10, message: '长度在3-10个字符', trigger: 'blur'}
        ]
      },
      role: localStorage.getItem('role'),
      admin: Cookies.get('admin') ? JSON.parse(Cookies.get('admin')) : {},
      user: Cookies.get('user') ? JSON.parse(Cookies.get('user')) : {}, // 如果 'user' 这个 Cookie 存在，它会返回该值
      dialogFormVisible:false,
      name:''
    };
  },
  created() {
    // 获取当前登录用户信息
    // 假设请求后端接口获取用户信息
    if(this.role==='1') {
      console.log(this.role)
      request.get('/user/current').then(res => {
        if (res.code === '200') {
          this.name = res.data.name; // 填充当前用户的名字到name（cookie没有存用户名称）
        }
      });
    }else{
      this.name = this.admin.username;
      console.log(this.admin)
    }
  },
  methods: {
    logout()
    {
      // 清除浏览器用户数据
      Cookies.remove('admin')
      Cookies.remove('user')
      this.$router.push('/login')
    },
    showPasswordDialog() {
      this.dialogFormVisible = true
    },
    savePass() {
      this.$refs['formRef'].validate((valid) => {
        if (valid) {
          if(this.role==='0'){
            request.put('/admin/password', this.form).then(res => {
              if (res.code === '200') {
                this.$notify.success("修改成功")
                // 修改成功之后需要重新登录
                Cookies.remove('admin')
                this.$router.push('/login')
              } else {
                this.$notify.error("修改失败")
              }
            })}else {
            request.put('/user/password', this.form).then(res => {
              if (res.code === '200') {
                this.$notify.success("修改成功")
                Cookies.remove('user')
                this.$router.push('/login')
              } else {
                this.$notify.error("修改失败")
              }
            })
          }

        }
      })
    },

  }
};
</script>

<style scoped>
/* 京东红主色 */
:deep(.jd-btn) {
  background: #e4393c !important;
  border-color: #e4393c !important;
  border-radius: 20px !important;
  transition: opacity 0.3s;
}
:deep(.jd-btn:hover) {
  opacity: 0.9;
}

/* 输入框样式 */
:deep(.jd-input .el-input__inner) {
  height: 44px !important;
  border-radius: 20px !important;
  border: 1px solid #ddd !important;
  transition: border-color 0.3s;
}
:deep(.jd-input .el-input__inner:focus) {
  border-color: #e4393c !important;
  box-shadow: 0 0 4px rgba(228, 57, 60, 0.2) !important;
}

/* 单选框样式 */
:deep(.jd-radio .el-radio__label) {
  color: #666 !important;
  font-family: 'PingFang SC', sans-serif;
}
:deep(.jd-radio .el-radio__input.is-checked .el-radio__inner) {
  background: #e4393c !important;
  border-color: #e4393c !important;
}

/* 侧边栏样式 */
.sidebar {
  width: 200px;
  min-height: calc(100vh - 62px);
  overflow: hidden;
  margin-right: 2px;
  background-color: #f5f5f5;
  box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
}

.sidebar .el-menu {
  border-right: none;
}

.sidebar .el-menu-item,
.sidebar .el-submenu__title {
  height: 50px;
  line-height: 50px;
  font-size: 14px;
  color: #333;
  transition: background-color 0.3s, color 0.3s;
}

.sidebar .el-menu-item:hover,
.sidebar .el-submenu__title:hover {
  background-color: #e4393c;
  color: #fff;
}

.sidebar .el-menu-item.is-active {
  background-color: #e4393c;
  color: #fff;
}

.sidebar .el-submenu .el-menu-item {
  padding-left: 50px !important;
}

/* 主体内容样式 */
.main-content {
  flex: 1;
  width: 0;
  background-color: white;
  padding: 20px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
</style>
```